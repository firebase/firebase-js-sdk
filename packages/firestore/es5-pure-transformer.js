/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import * as ts from 'typescript';

/**
 * This TypeScript transformer marks ES5-downleveled classes as "pure functions", so that tools such
 * as rollup and UglifyJS will drop them if they are unused in apps that depends on our libraries.
 *
 * It does so by looking at all synthetic "@class" comments generated by TypeScript down-leveling
 * transforms and then appends a "#__PURE__" comment to each of them. The later is picked up by
 * rollup, UglifyJS, etc.
 *
 * See rollup.config.lite.js for usage of this transformer with rollup.
 */
// eslint-disable-next-line import/no-default-export
export default function createTransformer() {
  return () => ({
    // "after" tells TypeScript to run this transformer AFTER all built-in ones, including the ones
    // that down-levels ES6 classes into ES5 plain function constructors. This is critical in order
    // for the transformer to take transpiled classes as input and work on the annotation.
    after: ctx => {
      function visitor(node) {
        const result = ts.visitEachChild(node, visitor, ctx);
        const comments = ts.getSyntheticLeadingComments(result);
        // See: https://github.com/microsoft/TypeScript/pull/16631
        if (comments && comments.some(c => c.text === '* @class ')) {
          // This annotation makes rollup and UglifyJS treat the IIFEs that create classes as pure.
          // See: https://github.com/rollup/rollup/issues/1293. And more references can be found at:
          // - https://rollupjs.org/guide/en/#treeshake (under treeshake.annotations)
          // - https://github.com/mishoo/UglifyJS/blob/master/README.md (search for #__PURE__)
          ts.addSyntheticLeadingComment(
            result,
            ts.SyntaxKind.MultiLineCommentTrivia,
            '#__PURE__'
          );
        }
        return result;
      }
      return file => ts.visitNode(file, visitor);
    }
  });
}
