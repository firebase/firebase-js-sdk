language: node_js
node_js:
  - 8
cache: yarn

# Define global C++ compiler version
env:
  global:
    - CXX=g++-4.8
before_install:
  - sudo apt-get -qq update
  - sudo apt-get install ssmtp bsd-mailx
  - echo -e $SSMTP_CONFIG | sudo tee /etc/ssmtp/ssmtp.conf
  # Yarn defaults to an old version, make sure we
  # get an up to date version
  - npm install -g yarn
  - '[ "${NPM_TOKEN+x}" ] && echo "//registry.npmjs.org/:_authToken=\${NPM_TOKEN}" > $HOME/.npmrc || echo "Skipping .npmrc creation";'
before_script:
  - cp config/ci.config.json config/project.json

# Misc Addons/Configs
dist: trusty
sudo: required
addons:
  apt:
    sources:
      - google-chrome
      - ubuntu-toolchain-r-test
    packages:
      - google-chrome-stable
      - g++-4.8

matrix:
  fast_finish: true

jobs:
  allow_failures:
    - script: ./scripts/saucelabs/run_flaky_tests.sh flaky_tests.log
  include:
    - stage: test
      script: xvfb-run yarn test
      after_success: yarn test:coverage
      env: '#= chrome headless test'
    - stage: test
      script: yarn test:saucelabs
      env: '#= cross browser test: all packages except database and firestore'
      if: type = push
    - stage: test
      script: ./scripts/saucelabs/run_flaky_tests.sh flaky_tests.log
      env: '#= cross browser test: database and firestore (allow_failures)'
      after_failure: ./scripts/saucelabs/report_flaky_tests_failure.sh flaky_tests.log
      if: type = push
    - stage: deploy
      script: skip
      # NPM Canary Build Config
      deploy:
        skip_cleanup: true
        provider: script
        script: yarn release --canary
      if: type = push AND repo = firebase/firebase-js-sdk AND branch = master
